name: Ejecutar Script de Reportes en VM Windows

on:
  workflow_dispatch: # Permite ejecutarlo manualmente

jobs:
  run-python-script:
    # Asegúrate de que el job se ejecute en tu runner con las etiquetas correctas
    runs-on: [self-hosted, windows, gui]

    steps:
      # 1. Clona el repositorio en la VM
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 2. Configura el entorno de Python de forma robusta
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          # Especifica la versión de Python que necesitas
          python-version: '3.10'

      # 3. Instala las dependencias del script desde requirements.txt
      - name: Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip
          pip install -r "${{ github.workspace }}/DMV Automation - 10 Jun V2/requirements.txt"
        shell: powershell

      # 4. Ejecuta el script y captura logs
      - name: Ejecutar One_new.py
        id: run_script
        run: |
          # Define la ruta del log de forma dinámica
          $logDir = "C:\Temp\RunnerLogs"
          New-Item -ItemType Directory -Force -Path $logDir
          $logFile = Join-Path $logDir "one_new_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
          
          Write-Output "Iniciando el script de Python..."
          Write-Output "El log se guardará en: $logFile"

          # Ejecuta el script y redirige la salida
          python -u "One_new.py" 2>&1 | Tee-Object -FilePath $logFile
          
          # Comprueba el código de salida y falla el job si es necesario
          if ($LASTEXITCODE -ne 0) {
            Write-Error "El script de Python falló con código $LASTEXITCODE."
            exit 1
          }

          Write-Output "Script finalizado con éxito."
        shell: powershell
        # Establece el directorio de trabajo a la carpeta del script
        working-directory: "${{ github.workspace }}/DMV Automation - 10 Jun V2"

      # 5. (Opcional pero recomendado) Sube el log como un artefacto
      - name: Subir log como artefacto
        if: always() # Se ejecuta incluso si el paso anterior falla
        uses: actions/upload-artifact@v4
        with:
          name: logs-one-new
          path: C:\Temp\RunnerLogs\*.log
